# 笔记应用数据文档

## 1. 文档概述

本文档详细描述了笔记应用的数据结构、存储格式和导出文件规范，确保数据的可读性、可移植性和跨平台兼容性。

## 2. 数据库结构

### 2.1 笔记表 (notes)

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| id | TEXT PRIMARY KEY | 笔记唯一标识符 | "f47ac10b-58cc-4372-a567-0e02b2c3d479" |
| title | TEXT NOT NULL | 笔记标题 | "今日早餐记录" |
| content | TEXT NOT NULL | 笔记内容（包含图片标记） | "今天吃了三明治\n[IMG:IMG_001.jpg]\n很美味" |
| creationTime | INTEGER NOT NULL | 创建时间戳（毫秒） | 1690000000000 |
| lastEditTime | INTEGER NOT NULL | 最后编辑时间戳（毫秒） | 1690000300000 |
| tags | TEXT | 标签列表（JSON格式） | '["早餐","记账_支出_20"]' |
| images | TEXT | 图片信息列表（JSON格式） | 见下方详细说明 |
| hasImages | INTEGER | 是否包含图片（0/1） | 1 |

### 2.2 图片数据结构

```json
[
  {
    "fileName": "IMG_20240101_143022_a1b2c3d4.jpg",
    "position": 25,
    "insertTime": "2024-01-01T14:30:22.000Z",
    "caption": "早餐照片"
  },
  {
    "fileName": "IMG_20240101_143156_e5f6g7h8.jpg",
    "position": 45,
    "insertTime": "2024-01-01T14:31:56.000Z",
    "caption": ""
  }
]
```

**字段说明**：
- `fileName`: 图片文件名，格式为 `IMG_YYYYMMDD_HHMMSS_随机字符.jpg`
- `position`: 图片在文本内容中的位置（字符索引）
- `insertTime`: 图片插入时间（ISO 8601格式）
- `caption`: 图片说明文字（可选）

## 3. 文件存储结构

### 3.1 应用目录结构

```
/Android/data/com.example.noteapp/files/
├── databases/
│   └── note_database.db          # Room数据库文件
├── Pictures/
│   └── note_images/               # 图片存储目录
│       ├── IMG_20240101_143022_a1b2c3d4.jpg
│       ├── IMG_20240101_143156_e5f6g7h8.jpg
│       └── ...
└── backups/                       # 备份文件目录（可选）
    ├── noteapp_backup_20240101_150000.zip
    └── ...
```

### 3.2 图片文件命名规范

**格式**: `IMG_YYYYMMDD_HHMMSS_随机字符.jpg`

**示例**: `IMG_20240101_143022_a1b2c3d4.jpg`

**说明**:
- `IMG_`: 固定前缀
- `YYYYMMDD`: 年月日（8位数字）
- `HHMMSS`: 时分秒（6位数字）
- `随机字符`: 8位随机字符串，避免文件名冲突
- `.jpg`: 统一使用JPEG格式

## 4. 备份文件格式

### 4.1 备份文件结构

备份文件为ZIP格式，包含以下内容：

```
noteapp_backup_YYYYMMDD_HHMMSS.zip
├── backup_metadata.json          # 备份元数据
├── notes.json                     # 笔记数据
└── images/                        # 图片文件夹
    ├── IMG_20240101_143022_a1b2c3d4.jpg
    ├── IMG_20240101_143156_e5f6g7h8.jpg
    └── ...
```

### 4.2 备份元数据 (backup_metadata.json)

```json
{
  "version": "1.0",
  "timestamp": 1690000000000,
  "noteCount": 25,
  "imageCount": 48,
  "appVersion": "1.0.0"
}
```

**字段说明**:
- `version`: 备份格式版本号
- `timestamp`: 备份创建时间戳（毫秒）
- `noteCount`: 备份中包含的笔记数量
- `imageCount`: 备份中包含的图片数量
- `appVersion`: 创建备份时的应用版本

### 4.3 笔记数据 (notes.json)

```json
[
  {
    "id": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
    "title": "今日早餐记录",
    "content": "今天吃了三明治\n[IMG:IMG_20240101_143022_a1b2c3d4.jpg]\n很美味",
    "creationTime": "2024-01-01T08:30:00.000Z",
    "lastEditTime": "2024-01-01T08:35:00.000Z",
    "tags": ["早餐", "记账_支出_20"],
    "images": [
      {
        "fileName": "IMG_20240101_143022_a1b2c3d4.jpg",
        "position": 25,
        "insertTime": "2024-01-01T14:30:22.000Z",
        "caption": "早餐照片"
      }
    ],
    "hasImages": true
  }
]
```

## 5. 图片标记系统

### 5.1 标记格式

在笔记内容中，图片通过特殊标记表示：

**格式**: `[IMG:文件名]`

**示例**: `[IMG:IMG_20240101_143022_a1b2c3d4.jpg]`

### 5.2 标记解析规则

1. **正则表达式**: `\\[IMG:[^\\]]+\\]`
2. **解析流程**:
   - 扫描文本内容，查找所有图片标记
   - 提取文件名，在图片数据中查找对应信息
   - 按标记位置顺序显示图片

### 5.3 内容分割示例

**原始内容**:
```
今天去公园散步，天气很好。

[IMG:IMG_20240101_143022_a1b2c3d4.jpg]

看到了很多美丽的花朵。

[IMG:IMG_20240101_143156_e5f6g7h8.jpg]

准备明天再来一次。
```

**解析结果**:
1. 文本段落: "今天去公园散步，天气很好。"
2. 图片: IMG_20240101_143022_a1b2c3d4.jpg
3. 文本段落: "看到了很多美丽的花朵。"
4. 图片: IMG_20240101_143156_e5f6g7h8.jpg
5. 文本段落: "准备明天再来一次。"

## 6. 数据迁移和兼容性

### 6.1 版本兼容性

| 备份版本 | 应用版本 | 兼容性 | 说明 |
|----------|----------|--------|------|
| 1.0 | 1.0.0+ | ✅ 完全兼容 | 当前版本格式 |
| 未来版本 | 未来版本 | 🔄 向后兼容 | 保持向后兼容性 |

### 6.2 数据验证

**备份文件验证**:
1. ZIP文件完整性检查
2. 必需文件存在性验证（metadata.json, notes.json）
3. JSON格式有效性验证
4. 图片文件完整性检查

**数据恢复验证**:
1. 笔记ID唯一性检查
2. 图片文件关联性验证
3. 时间戳格式验证
4. 标签格式验证

### 6.3 错误处理

**常见错误及处理**:
- **图片文件缺失**: 显示占位符，记录错误日志
- **JSON格式错误**: 跳过错误数据，继续处理其他数据
- **版本不兼容**: 提示用户升级应用或使用兼容版本
- **存储空间不足**: 提示用户清理空间或选择其他位置

## 7. 性能优化

### 7.1 图片压缩规范

**压缩参数**:
- 最大分辨率: 1024×1024像素
- 压缩质量: 70%
- 格式转换: 统一转为JPEG格式
- 文件大小: 目标≤500KB/张

### 7.2 数据库优化

**索引策略**:
```sql
CREATE INDEX idx_notes_creation_time ON notes(creationTime);
CREATE INDEX idx_notes_last_edit_time ON notes(lastEditTime);
CREATE INDEX idx_notes_has_images ON notes(hasImages);
```

**查询优化**:
- 分页加载笔记列表
- 延迟加载图片内容
- 缓存常用查询结果

## 8. 安全性考虑

### 8.1 数据保护

- **本地存储**: 应用私有目录，其他应用无法访问
- **备份加密**: 支持ZIP文件密码保护（可选）
- **权限控制**: 最小权限原则，仅申请必要权限

### 8.2 隐私保护

- **图片隐私**: 图片存储在应用私有目录
- **数据清理**: 卸载应用时自动清理所有数据
- **导出控制**: 用户主动操作才能导出数据

## 9. 开发者指南

### 9.1 添加新字段

当需要添加新的数据字段时：

1. **数据库迁移**:
```kotlin
val MIGRATION_2_3 = object : Migration(2, 3) {
    override fun migrate(database: SupportSQLiteDatabase) {
        database.execSQL("ALTER TABLE notes ADD COLUMN newField TEXT DEFAULT ''")
    }
}
```

2. **备份格式更新**:
- 更新备份版本号
- 保持向后兼容性
- 更新文档说明

### 9.2 图片处理扩展

**添加新图片格式支持**:
```kotlin
fun convertToJpeg(inputUri: Uri, context: Context): File {
    // 格式转换逻辑
}
```

**自定义压缩参数**:
```kotlin
data class CompressionConfig(
    val maxWidth: Int = 1024,
    val maxHeight: Int = 1024,
    val quality: Int = 70
)
```

## 10. 更新日志

### v1.0.0 (2024-01-01)
- 初始版本
- 基础笔记功能
- 图片插入和显示
- 标签系统
- 搜索功能
- 日历视图
- 记账统计
- 数据备份与恢复

### 未来版本计划
- 图片标注功能
- 云同步支持
- OCR文字识别
- 高级图片编辑
- 数据可视化增强

---

**文档维护**: 本文档随应用功能更新而更新，确保数据格式说明的准确性和完整性。